let db=require("../models"),passport=require("../config/passport"),scrapeItem=require("../controllers/scraper");const item=require("../models/item"),{response}=require("express"),getCurrencies=require("../controllers/currenciesController"),moment=require("moment");let lastUpdate,selectCur={};const fetchCurrencies=()=>{getCurrencies(a=>{for(key in lastUpdate=a,a=a.conversion_rates,a)("USD"===key||"CAD"===key||"EUR"===key||"GBP"===key||"RUB"===key||"JPY"===key||"CNY"===key||"AUD"===key)&&(selectCur[key]=a[key])})};fetchCurrencies(),module.exports=function(a){a.post("/api/login",passport.authenticate("local"),function(a,b){b.json(a.user)}),a.post("/api/signup",function(a,b){db.User.create({email:a.body.email,password:a.body.password}).then(function(){b.redirect(307,"/api/login")}).catch(function(a){b.status(401).json({err:a})})}),a.get("/logout",function(a,b){console.log("User logged out... Bye!"),a.logout(),b.redirect("/")}),a.get("/api/user_data",function(a,b){a.user?b.json({email:a.user.email,id:a.user.id}):b.json({msg:"User is not logged in!"})}),a.get("/api/currencies",function(a,b){a.user?((!lastUpdate||lastUpdate.time_last_update_utc.slice(0,16)!==moment().format("ddd, DD MMM YYYY"))&&(console.log("updating curencies"),fetchCurrencies()),b.json(selectCur)):b.json({msg:"User is not logged in!"})}),a.get("/api/items",(a,b)=>{a.user?db.Item.findAll({where:{UserId:a.user.id}}).then(a=>{b.json(a)}).catch(function(a){b.status(401).json({err:a})}):b.json({msg:"User is not logged in!"})}),a.get("/api/items/:id",(a,b)=>{a.user?db.Item.findOne({where:{UserId:a.user.id,id:a.params.id}}).then(a=>{b.render("viewitem",{items:a})}):b.json({msg:"User is not logged in!"})}),a.delete("/api/items/:id",(a,b)=>{a.user?db.Item.destroy({where:{UserId:a.user.id,id:a.params.id}}).then(a=>b.json(a)).catch(function(a){b.status(401).json({err:a})}):b.json({msg:"User is not logged in!"})}),a.put("/api/items/:id",(a,b)=>{a.user?db.Item.update(a.body,{where:{UserId:a.user.id,id:a.params.id}}).then(a=>b.json(a)).catch(function(a){b.status(401).json({err:a})}):b.json({msg:"User is not logged in!"})}),a.post("/api/scrape",(a,b)=>{a.user?a.body.url?scrapeItem(a.body.url,c=>{c.title?(c.UserId=a.user.id,db.Item.create(c,{logging:!1}).then(()=>{console.log("created item: ",c.title),b.status(201).json(c)})):b.status(404).send("Unable to get item data")}):b.status(404).end():b.status(401).json({msg:"User is not logged in!"})}),a.post("/api/scrape/:id",(a,b)=>{a.user?db.Item.findOne({where:{id:a.params.id}}).then(a=>{console.log("checkng update for item id: ",a.id),scrapeItem(a.url,c=>{console.log("compare: ",+a.initialPrice,c.initialPrice),c.initialPrice!==+a.initialPrice&&c.initialPrice!==+a.newPrice?(a.newPrice=c.initialPrice,a.isUpdated=!0,console.log("there is an update!"),db.Item.update({newPrice:a.newPrice,isUpdated:!0},{where:{id:a.id}}).then(a=>{console.log("updated item: ",a),b.status(200).send("updated item!")})):(console.log("no update!"),db.Item.update({isUpdated:!1},{where:{id:a.id}}),b.status(200).send("no update"))})}).catch(()=>{console.log("Error, item is not found"),b.status(404).send("Item is not found")}):b.status(401).end()})};